function checkSyncWall(){var e=readCookie(g_SESSION_ID_TAG);if(!e||e=="null")e="";g_PAGEURL=window.location.toString();log("g_PAGEURL: "+g_PAGEURL);var t=getAuthToken(g_PAGEURL);if(t!=""){createCookie(g_AUTHTOKEN,t,36500,"/");var n=g_PAGEURL.toString().indexOf("sp-tk");g_PAGEURL=g_PAGEURL.toString().substr(0,n)}var r=g_PAGEURL;g_PAGEURL=g_PAGEURL.replace(/#.*$/,"");var t=readCookie(g_AUTHTOKEN);if(!t||t=="null")t="";var i,s=document.getElementsByName("__sync_contentCategory");if(!s||!s[0])return;i=s[0].content;log("contentId: "+i);var o=referringDomain(document.referrer);log("referrer: "+o);log("encoded referrer:"+document.referrer);var u="";log("recentlyVisited: "+recentlyVisited(g_PAGEURL.toString()));var a=getChannelSource(g_PAGEURL,"");log("Channel: "+a);recentlyVisited(g_PAGEURL.toString())?createCookie(g_HISTORY,updateHistory(g_PAGEURL.toString()),36500,"/"):callServer(e,t,i,u,o,r,"serverCallback",a)}function getChannelSource(e,t){var n="";if(e){var r="E-Edition";n=e.match("/eedition/")?r:n}return n}function recentlyVisited(e){var t=pageHistory();if(t==null)return!1;if(g_REFRESHLIMIT===0)return!1;var n=t.indexOf(e);if(n==-1)return!1;if(g_REFRESHTIMELIMIT===0)return!1;var r=t[n+1];return timeDiff((new Date).getTime(),r)>g_REFRESHTIMELIMIT?!1:!0}function pageHistory(){var e=readCookie(g_HISTORY);return!e||e=="null"?null:e.split(",")}function timeDiff(e,t){var n=e-t,r=Math.floor(n/6e4);return r}function updateHistory(e){var t=pageHistory(),n=-1;t!=null&&(n=t.indexOf(e));if(n==-1){t==null&&(t=new Array);if(t.length/2>=g_REFRESHLIMIT)replaceOldest(t,e);else{t.push(e);t.push((new Date).getTime())}}else t.splice(n+1,1,(new Date).getTime());return t.join(",")}function replaceOldest(e,t){var n=(new Date("12/31/2199")).getTime(),r=-1;for(var i=1;i<e.length;i+=2)if(e[i]<n){n=e[i];r=i}if(r>0)e.splice(r-1,2,t,(new Date).getTime());else{e.push(t);e.push((new Date).getTime())}}function getAuthToken(e){var t=getParameterByName("sp-tk");log("auth-token: "+t);return t}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t="[\\?&]"+e+"=([^&#]*)",n=new RegExp(t),r=n.exec(window.location.search);return r==null?"":decodeURIComponent(r[1].replace(/\+/g," "))}function referringDomain(e){var t=e.split("/"),n="";t.length>2&&(n="http://"+t[2]+"/foo.htm");return n}function callServer(e,t,n,r,i,s,o,u){var a=encodeURI(e),f=encodeURIComponent(n),l=encodeURIComponent(r),c=encodeURIComponent(i),h=encodeURIComponent(s),p=encodeURIComponent(o),d=encodeURIComponent(t),v="https://stage.syncaccess.net/wc/bb/api/svcs/meter",m=encodeURI(u),g=v+"?sessionId="+a+"&contentId="+f+"&externalId="+l+"&referrer="+c+"&page="+h+"&authToken="+d+"&source="+m+"&callback="+p+"&nocache="+(new Date).getTime();log("serverURL: "+g);InsertScriptElement(g)}function InsertScriptElement(e){var t=document.createElement("script");t.setAttribute("type","text/javascript");t.setAttribute("src",e);log("script: "+t.outerHTML);var n=document.getElementsByTagName("head").item(0);n||(n=document.getElementsByTagName("body").item(0));n.appendChild(t)}function serverCallback(e){var t=e.authorized.toLowerCase(),n=e.sessionIdentifier,r=e.overlayContent,i=e.authToken,s=e.showWarning,o=readCookie("tncms-authtoken");log("serverCallback Data:");log("    authorized:  "+t);log("    sessionId:   "+n);log("    authToken:   "+i);log("    showWarning: "+s);log("    overlayContent:\n"+r);if(t!="true")if(r.substring(0,9)=="redirect:"){createCookie(g_SESSION_ID_TAG,n,36500,"/");displayRedirect(r.substring(9))}else if(o&&s=="true")log("User is logged into Town News. No warning.");else{displayOverlay(r,s);s=="true"&&createCookie(g_HISTORY,updateHistory(g_PAGEURL.toString()),36500,"/")}else createCookie(g_HISTORY,updateHistory(g_PAGEURL.toString()),36500,"/");n&&n!=""&&createCookie(g_SESSION_ID_TAG,n,36500,"/");i&&i!=""&&createCookie(g_AUTHTOKEN,i,36500,"/")}function createCookie(e,t,n,r){var i;if(n){var s=new Date;s.setTime(s.getTime()+n*24*60*60*1e3);i="; expires="+s.toGMTString()}else i="";document.cookie=e+"="+t+i+"; path="+r+";"}function readCookie(e){var t=e+"=";log(document.cookie);var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r];while(i.charAt(0)==" ")i=i.substring(1,i.length);if(i.indexOf(t)==0)return i.substring(t.length,i.length)}return null}function eraseCookie(e){createCookie(e,"x",-1,"/")}function forceCookie(){var e=document.getElementById("cookieVal");if(e){var t=e.value;createCookie(g_SESSION_ID_TAG,t,1)}}function loadCustomStyleSheet(e){var t=document.getElementsByTagName("head").item(0),n=document.createElement("link");n.type="text/css";n.rel="stylesheet";n.href=e;n.setAttribute("id","_customCss_");t.appendChild(n)}function displayRedirect(e){top.location.href=e}function displayOverlay(e,t){e=wescomReplaceString(e);var n=wescomOverlayCSS();g_DEBUG&&(e+='<input type="button" class="sync-overlay-debug" value="Reset Session" onclick="eraseCookie(\''+g_SESSION_ID_TAG+"'); return false;\" />");var r=document.getElementsByTagName("body").item(0);loadCustomStyleSheet(n);var i=document.createElement("div");i.setAttribute("id","syncronexOverlay");var s=document.createElement("div");s.setAttribute("id","syncronexOverlayContent");if(t=="true"){i.setAttribute("class","syncronex-warning-overlay");s.setAttribute("class","syncronex-warning-overlay-content")}else{i.setAttribute("class","syncronex-wall-overlay");s.setAttribute("class","syncronex-wall-overlay-content")}r.appendChild(i);s.innerHTML=e;r.appendChild(s)}function GetWindowSize(){var e={Width:0,Height:0};if(typeof window.innerWidth=="number"){e.Width=window.innerWidth;e.Height=window.innerHeight}else if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight)){e.Width=document.documentElement.clientWidth;e.Height=document.documentElement.clientHeight}else if(document.body&&(document.body.clientWidth||document.body.clientHeight)){e.Width=document.body.clientWidth;e.Height=document.body.clientHeight}return e}function log(e){g_DEBUG&&window.console&&window.console.log&&console.log(e)}function dismissOverlay(){var e=document.getElementById("syncronexOverlay"),t=document.getElementById("syncronexOverlayContent"),n=document.getElementById("_customCss_");typeof t!="undefined"&&removeElement(t);typeof e!="undefined"&&removeElement(e);typeof n!="undefined"&&removeElement(n)}function removeElement(e){e.parentNode.removeChild(e)}Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(this==null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(n===0)return-1;var r=0;if(arguments.length>1){r=Number(arguments[1]);r!=r?r=0:r!=0&&r!=Infinity&&r!=-Infinity&&(r=(r>0||-1)*Math.floor(Math.abs(r)))}if(r>=n)return-1;var i=r>=0?r:Math.max(n-Math.abs(r),0);for(;i<n;i++)if(i in t&&t[i]===e)return i;return-1});var g_SESSION_ID_TAG="syncwall-sessionid",g_AUTHTOKEN="syncwall-authToken",g_HISTORY="syncwall-history",g_REFRESHLIMIT=10,g_REFRESHTIMELIMIT=4,g_PAGEURL,g_DEBUG=!1;if(g_DEBUG){g_REFRESHLIMIT=0;g_REFRESHTIMELIMIT=0}window.addEventListener?window.addEventListener("load",checkSyncWall,!1):window.attachEvent&&window.attachEvent("onload",checkSyncWall);